parameters:
  env: ''
  azure_sub: ''
  name: ''
  ADOTOKEN: ''
  ADOPOOL: ''
  ADOORG: ''

steps:
- task: AzureCLI@2
  displayName: Deploy Agent to K8s
  inputs:
    azureSubscription: ${{parameters.azure_sub}} 
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
        RESOURCE_GROUP_NAME=${{parameters.name}}${{parameters.env}}
        ARM_SUBSCRIPTION_ID=$(az account show --query id --out tsv)
        az account set --subscription $ARM_SUBSCRIPTION_ID
        az aks get-credentials --admin --name $RESOURCE_GROUP_NAME-aks --resource-group $RESOURCE_GROUP_NAME

        az configure --defaults acr=${RESOURCE_GROUP_NAME}
        
        curl https://raw.githubusercontent.com/helm/helm/master/scripts/get > get_helm.sh
        chmod 700 get_helm.sh
        ./get_helm.sh -v v3.0.0

        helm init 

        az acr helm repo add
        helm repo update

        az acr helm list
        helm repo list
        helm fetch ${RESOURCE_GROUP_NAME}/azpagent

        ADO_TOKEN=$(tr -dc '[[:print:]]' <<< ${ADOTOKEN})
        ADO_POOL=$(tr -dc '[[:print:]]' <<< ${ADOPOOL})
        ADO_ORG=$(tr -dc '[[:print:]]' <<< ${ADOORG})

        echo "Variables..."
        echo $ADO_TOKEN
        echo $ADO_POOL
        echo $ADP_ORG

        echo "deploying agent to k8s"

        echo "helm upgrade --install azpagent ${RESOURCE_GROUP_NAME}/azpagent \
            --set azp.url='https://dev.azure.com/${ADO_ORG}' --set azp.token=${ADOTOKEN} \
            --set azp.pool=${ADO_POOL} --set image.repository=${RESOURCE_GROUP_NAME}.azurecr.io/azpagent"

        helm install azpagentes ${RESOURCE_GROUP_NAME}/azpagent \
            --set azp.url="https://dev.azure.com/ATTDevOps" \
            --set azp.token=MTIzNDUK \
            --set azp.pool=Default \
            --set image.repository=${RESOURCE_GROUP_NAME}.azurecr.io/azpagent 

        # kubectl apply -f ../config/kured.yaml

